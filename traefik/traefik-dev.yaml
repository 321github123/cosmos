---
# Listen for everything coming in on the standard HTTP port
entrypoints:
  web:
    address: ":80"
http:
  middlewares:
    # Removes the first part of the url before passing onto the service
    # ie. /cosmos-api/api becomes /api
    removeFirst:
      replacePathRegex:
        regex: "^/([^/]*)/(.*)"
        replacement: "/$2"
    # Adds /tools/base to the beginning of the given url
    # ie. /index.html becomes /tools/base/index.html
    addToolsBase:
      replacePathRegex:
        regex: "^/(.*)"
        replacement: "/tools/base/$1"
    # Adds index.html to the end of urls that end in /
    # ie. /something/ becomes /something/index.html
    addIndex:
      replacePathRegex:
        regex: "(.*)/$"
        replacement: "$1/index.html"
    # Handle any not found errors from the regular default route
    # to pull from index.html to allow the SPA to work with the
    # URL
    indexOnNotFound:
      errors:
        status:
          - "400-499"
        service: service-minio
        query: "/tools/base/index.html"
  routers:
    # This is the default route for everything that doesn't match a more specific route
    # It gets us to the base cosmos application
    web-router:
      rule: Host(`localhost`)
      middlewares:
        # Add /tools/base/ and optionally index.html for ending in /
        # ie. / becomes /tools/base/index.html before being passed to Minio
        # This gets us to the right url for Minio to serve the static webpage
        # 404 errors will serve /tools/base/index.html to make the single page app
        # work as expected
        - "addToolsBase"
        - "addIndex"
        - "indexOnNotFound"
      service: service-minio
    # Route to the cosmos cmd/tlm api
    api-router:
      rule: PathPrefix(`/cosmos-api`)
      middlewares:
        # Remove /cosmos-api from urls
        - "removeFirst"
      service: service-api
    # Route to the script api
    script-router:
      rule: PathPrefix(`/script-api`)
      middlewares:
        # Remove /script-api from urls
        - "removeFirst"
      service: service-script
    # Route to other tool plugins hosted statically in Minio
    tools-router:
      rule: PathPrefix(`/tools`)
      middlewares:
        # 404 errors will serve /tools/base/index.html to make the single page app
        # work as expected
        - "indexOnNotFound"
      service: service-minio
  services:
    # The COSMOS cmd/tlm api service
    service-api:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:2901"
    # The COSMOS script api service
    service-script:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:2902"
    # The Minio S3 file server
    service-minio:
      loadBalancer:
        servers:
          - url: "http://cosmos-minio:9000"
# Declare the routes are currently coming from this file, not dynamically
providers:
  file:
    filename: /etc/traefik/traefik.yaml
# api:
#   dashboard: true
#   insecure: trues
# log:
#   filePath: '/etc/traefik/traefik.log'
#   level: 'DEBUG'
# accessLog:
#   filePath: '/etc/traefik/access.log'
#   fields:
#     defaultMode: keep
#     headers:
#       defaultMode: keep
