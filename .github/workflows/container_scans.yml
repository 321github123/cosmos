# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Cosmos 5 Container Scans

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  cosmos-build:
    if: ${{ github.actor != 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: cosmos-control.sh build
        # This `shell` line is required to get around a known issue: https://github.com/actions/runner/issues/241#issuecomment-745902718
        shell: 'script -q -e -c "bash {0}"'
        run: ./cosmos-control.sh build
  cosmos-scan:
    needs: cosmos-build
    strategy:
      matrix:
        container: [base, ruby] # node, traefik, operator, cmd-tlm-api, script-runner-api, redis, minio-init
    steps:
      - name: Run the Anchore scan action itself with GitHub Advanced Security code scanning integration enabled
        uses: anchore/scan-action@b08527d5ae7f7dc76f9621edb6e49eaf47933ccd
        with:
          image: "docker.io/ballaerospace/cosmosc2-${{ matrix.container }}:latest"
          acs-report-enable: true
          severity-cutoff: critical # low, medium, high, critical
          fail-build: false
      - name: Upload Anchore Scan Report
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: results.sarif
